<!DOCTYPE html>
<html>
<head>
    <title>Vid2MP3</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css">

    <link rel="stylesheet" type="text/css" href="css/style.css" />
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js" type="text/javascript"></script>
    
	<script>
    
    $(document).on('click', '.btn_get_yt_video_link', function(event) {
        event.preventDefault();

        var link = $('.yt_video_link').val();
        var data = {url: link};
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/send', true);
        xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        xhr.send(JSON.stringify(data));
        xhr.onload = function(e) {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    console.log(xhr.responseText);
                    /*
                    var urls = xhr.responseText.split("url\\");
                    var index1 = xhr.responseText.indexOf("<title>");
                    var index2 = xhr.responseText.indexOf(" - YouTube</title>");
                    //console.log(index1, index2);
                    var video_title = xhr.responseText.substring(index1+7, index2);
                    //console.log(video_title+"AAA");


                    //urls[2] -> 18, urls[16] -> 140
                    index1 = urls[2].indexOf('https');
                    index2 = urls[2].indexOf('mimeType');
                    var str = urls[2].substring(index1, index2-5);
                    //console.log(str);
                    str = decodeURIComponent(str);
                    str = str.replace(/\\u0026/g, "&");
                    var video_link = str.replace(/\\/g, "");


                    //console.log(video_file);
                    var c = ''
                    +'<br>'
                    +'<span class="btn btn-primary btn-start"> Start</span>';

                    var d = ''
                    +'<br>'

                    +'<video src="'+video_link+'" controls autoplay controlsList="nodownload" oncontextmenu="return false;" height="350" width="100%">'
                    +'</video>';

                    $('.btns').html(c);
                    $('.youtube_video').html(d);
                    
                    
                    $(document).on('click', '.btn-start', function(event) {
                        $.get('proxy.php?source='+encodeURIComponent(video_link)+'&video_title='+encodeURIComponent(video_title), function(e) {
                            if(e == "File does not exist. Error!") {
                                alert("Error!");
                            }else {
                                c = ''
                                +'<span class="btn btn-primary btn-start"> Start</span>'
                                +'<button type="button" class="btn btn-danger btn-download"> Download</button>';
                                $('.btns').html(c);
                            }
                        });
                    });
                    

                    $(document).on('click', '.btn-download', function(event) {
                        location.replace('download.php?video_title='+encodeURIComponent(video_title));
                        $('button').prop('disabled', true);
                    });
                */
                } else {
                        console.error(xhr.statusText);
                } 
            }
        }

        xhr.onerror = function (e) {
            console.error(xhr.statusText);
        };
    });
    

    </script>

</head>
<body>

<div id="pcontent">

    <h1>Video To MP3 Downloader</h1>
    <br><br>
    <div class="control">
        <label for="ex1">Enter Youtube Video Link</label><br><br>
        <input class="form-control yt_video_link" type="text" placeholder="Video URL e.g. https://www.youtube.com/watch?v=MtN1YnoL46Q"><br><br>
        <span class="btn btn-success btn_get_yt_video_link">Get Video</span>
    </div>

    <br><br>

    <div class="btns"></div>
    <div class="youtube_video"></div>
</div>
</body>

</html>

